{% extends "layout.html" %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-8">

    <!-- 1. Search Bar -->
    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-50 relative overflow-hidden">
        <div class="absolute right-0 top-0 w-32 h-32 bg-blue-50 rounded-bl-full opacity-50"></div>
        
        <h2 class="text-xl font-bold text-[#0A2540] mb-4 flex items-center gap-2 relative z-10">
            <i class="fa-solid fa-magnifying-glass-chart text-[#E2136E]"></i> ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶á‡¶®‡¶∏‡¶æ‡¶á‡¶ü (Referral Check)
        </h2>
        
        <form method="POST" action="/admin/ref-check" class="flex gap-3 relative z-10">
            <div class="relative w-full">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fa-regular fa-envelope text-gray-400"></i>
                </div>
                <input type="email" name="email" required placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ (ex: user@gmail.com)" value="{{ search_email }}"
                       class="w-full pl-10 p-3.5 border border-gray-200 rounded-xl focus:outline-[#E2136E] focus:ring-1 focus:ring-[#E2136E] bg-gray-50 focus:bg-white transition">
            </div>
            <button type="submit" class="bg-[#0A2540] text-white px-8 py-3.5 rounded-xl font-bold hover:bg-opacity-90 transition shadow-lg flex items-center gap-2">
                <i class="fa-solid fa-search"></i> <span class="hidden md:inline">‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</span>
            </button>
        </form>
    </div>

    {% if target_user %}
    <!-- 2. Target User Profile Card -->
    <div class="bg-white rounded-3xl shadow-lg border border-blue-50 overflow-hidden">
        
        <!-- Card Header -->
        <div class="bg-[#0A2540] p-5 text-white flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="h-14 w-14 bg-white/10 rounded-full flex items-center justify-center text-3xl backdrop-blur-sm border-2 border-white/20">
                    <i class="fa-regular fa-id-card"></i>
                </div>
                <div>
                    <h3 class="font-bold text-lg">{{ target_user.email }}</h3>
                    <p class="text-xs text-gray-300 font-mono flex items-center gap-1">
                        <i class="fa-solid fa-fingerprint"></i> ID: {{ target_user.referral_code }}
                    </p>
                </div>
            </div>
            
            <div class="text-right bg-white/10 px-4 py-2 rounded-xl backdrop-blur-sm">
                <p class="text-[10px] text-gray-300 uppercase tracking-wider mb-1">‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶õ‡¶ø‡¶≤</p>
                <p class="font-mono font-bold text-green-400 text-sm flex items-center justify-end gap-2">
                    <i class="fa-solid fa-clock"></i>
                    {% if target_user.last_login %}
                        {{ target_user.last_login[:10] }} | {{ target_user.last_login[11:16] }}
                    {% else %}
                        Offline
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- Card Stats -->
        <div class="p-6 grid grid-cols-2 md:grid-cols-4 gap-6 text-center divide-x divide-gray-100">
            <div>
                <p class="text-xs text-gray-500 font-bold uppercase mb-1">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p>
                <p class="text-2xl font-bold text-[#E2136E]">‡ß≥ {{ target_user.balance }}</p>
            </div>
            <div>
                <p class="text-xs text-gray-500 font-bold uppercase mb-1">‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞</p>
                <p class="text-2xl font-bold text-[#0057FF]">{{ count }}</p>
            </div>
            <div>
                <p class="text-xs text-gray-500 font-bold uppercase mb-1">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</p>
                {% if target_user.is_active %}
                    <span class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">
                        <i class="fa-solid fa-check-circle"></i> Active
                    </span>
                {% else %}
                    <span class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">
                        <i class="fa-solid fa-lock"></i> Unpaid
                    </span>
                {% endif %}
            </div>
            <div>
                <p class="text-xs text-gray-500 font-bold uppercase mb-1">‡¶¨‡ßç‡¶Ø‡¶æ‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</p>
                {% if target_user.is_banned %}
                    <span class="text-red-600 font-bold text-sm"><i class="fa-solid fa-ban"></i> BANNED</span>
                {% else %}
                    <span class="text-green-600 font-bold text-sm"><i class="fa-solid fa-shield-check"></i> Safe</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 3. Referral List Table -->
    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-50">
        <div class="flex items-center justify-between mb-5">
            <h3 class="font-bold text-[#0A2540] flex items-center gap-2">
                <i class="fa-solid fa-sitemap text-blue-600"></i> ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡¶ï‡ßÉ‡¶§ ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü
            </h3>
            <span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold">Total: {{ count }}</span>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left border-collapse">
                <thead>
                    <tr class="bg-gray-50 text-gray-600 border-b border-gray-200">
                        <th class="p-4 rounded-tl-xl font-bold">User Email</th>
                        <th class="p-4 font-bold">Join Date</th>
                        <th class="p-4 font-bold">Last Active</th>
                        <th class="p-4 rounded-tr-xl font-bold text-right">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for ref in referrals %}
                    <tr class="hover:bg-gray-50 transition group">
                        <td class="p-4">
                            <div class="font-bold text-[#0A2540]">{{ ref.email }}</div>
                            <div class="text-[10px] text-gray-400">ID: {{ ref.referral_code }}</div>
                        </td>
                        <td class="p-4 text-gray-500 font-mono">
                            {{ ref.created_at[:10] }}
                        </td>
                        <td class="p-4 text-gray-500 font-mono text-xs">
                            {% if ref.last_login %}
                                <span class="text-green-600">{{ ref.last_login[:10] }}</span> <span class="text-gray-400">{{ ref.last_login[11:16] }}</span>
                            {% else %}
                                <span class="text-gray-300">-</span>
                            {% endif %}
                        </td>
                        <td class="p-4 text-right">
                            {% if ref.is_active %}
                                <span class="bg-green-50 text-green-700 px-3 py-1 rounded-lg text-xs font-bold border border-green-100">
                                    Paid
                                </span>
                            {% else %}
                                <span class="bg-red-50 text-red-700 px-3 py-1 rounded-lg text-xs font-bold border border-red-100">
                                    Unpaid
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="p-10 text-center text-gray-400 bg-gray-50 rounded-xl border border-dashed">
                            <div class="text-2xl mb-2">ü§∑‚Äç‚ôÇÔ∏è</div>
                            ‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡¶æ‡¶â‡¶ï‡ßá ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá‡¶®‡¶ø‡•§
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}
